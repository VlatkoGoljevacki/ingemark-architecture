# PACE Structurizr Architecture

## Workspace Structure

The `workspace.dsl` defines the PACE architecture using the [C4 model](https://c4model.com/) via [Structurizr DSL](https://docs.structurizr.com/dsl).

### Views

| View | Key | Description |
|---|---|---|
| System Context (L1) | `SystemContext` | High-level view of PACE Web and all connected systems/actors |
| PACE Platform Containers (L2) | `PaceWebContainers` | Expanded view of all PACE containers + external systems |
| PACE AI Suite Containers (L2) | `PaceAiContainers` | Focused view of AI Suite internals |

## Structurizr Findings & Patterns

### Container View Scoping

Each `container` view is scoped to a single software system (the "star"). Only that system's containers are expanded; other software systems appear as collapsed boxes.

```dsl
# This view is scoped to paceWeb - only paceWeb's containers expand
container paceWeb "PaceWebContainers" "..." {
    include *
}
```

**Problem:** If you have two systems (e.g., PACE Web and PACE AI Suite) and want both expanded in one diagram, `include *` only expands the scoped system's containers.

**Solution:** Use explicit includes to pull in containers from other systems. Instead of `include *`, list every element by name:

```dsl
container paceWeb "PaceWebContainers" "..." {
    # PACE Web containers (expanded because paceWeb is the star)
    include pace paceDb
    # PACE AI containers (also expanded via explicit include)
    include paceAiBackend mcpServer assistcraftDb  # assistcraftDb displays as "PACE AI DB"
    # Everything else
    include manager admin agent ...
}
```

This technique comes from the [Structurizr cookbook](https://docs.structurizr.com/cookbook). When you explicitly include containers from another system, they render expanded in the diagram.

### Groups in Container Views

**Limitation:** In Structurizr container views, group boundary rectangles (dashed borders) only render around **Containers**, not around **Software Systems**. External systems included in a container view will appear as standalone boxes without any group boundary, even if they are defined inside a `group` block in the model.

Groups render correctly in System Context views because all elements there are Software Systems.

**Workaround:** Use color-coding via tags to visually distinguish logical groups. See [Color-Coding by Group](#color-coding-by-group) below.

### Color-Coding by Group

Since group boundaries don't render around external systems in container views, we use tag-based color-coding to visually convey grouping:

| Group | Tag | Color | Hex |
|---|---|---|---|
| Google Workspace | `GoogleWorkspace` | Green | `#34A853` |
| Exotel | `Exotel` | Purple | `#7B1FA2` |
| Real Estate Portals | `RealEstatePortal` | Deep Orange | `#E65100` |
| Existing Allsopp CRM | `Deprecated` | Amber (70% opacity) | `#d4a017` |
| Infrastructure | `Infrastructure` | Dark Grey | `#666666` |
| PACE Platform | `Ingemark` | Blue | `#1168bd` |

Tags are applied as comma-separated values in the element definition:

```dsl
googleIdentity = softwareSystem "Google Identity Services" "..." "External,GoogleWorkspace"
```

Structurizr applies styles in definition order. Later-matching tag styles override earlier ones, so `GoogleWorkspace` style overrides the base `External` grey.

### Implied Relationships

Container-level relationships automatically create implied system-level relationships. For example:

```dsl
pace -> salesforceAdapter "..." "HTTP REST"
```

This implies `paceWeb -> salesforceAdapter` at the system level, which means `salesforceAdapter` will appear in the Context diagram unless explicitly excluded:

```dsl
systemContext paceWeb "SystemContext" "..." {
    include *
    exclude salesforceAdapter
}
```

### Manual Layout

Structurizr stores element positions in `workspace.json`. When modifying the DSL:

- **Context diagram positions are preserved** as long as you don't change the view key (`"SystemContext"`)
- Adding `autoLayout` to a view overrides manual positions
- Removing `autoLayout` lets you manually reposition elements again
- The `workspace.json` file is regenerated by Structurizr; don't edit it directly

### LikeC4 Comparison

[LikeC4](https://likec4.dev/) was evaluated as an alternative:

- **More flexible views:** Unscoped views, can include elements from anywhere without the single-system constraint
- **Manual layout:** Exists but is unstable as of early 2025 - layouts get corrupted on edits, export issues with manual positions, connector routing problems
- **Verdict:** Structurizr is more reliable for manually positioned diagrams

## Interface IDs

All container-level relationships include interface IDs for traceability:

| ID | Description |
|---|---|
| `INTF-USER-01..03` | Actor to PACE (Manager, Admin, Agent) |
| `INTF-AUTH-02` | PACE to Google Identity |
| `INTF-DB-01` | PACE to Pace DB |
| `INTF-DB-02` | AI Backend to PACE AI DB |
| `INTF-AI-01` | PACE to AI Backend (SSE streaming) |
| `INTF-AI-02` | AI Backend to PACE (schema fetch) |
| `INTF-AI-03` | MCP Server to PACE (data fetch) |
| `INTF-AI-04..0x` | AI Backend to MCP Servers |
| `INTF-PACE-01` | PACE to Call Center (softphone) |
| `INTF-PACE-02` | PACE to Looker Studio |
| `INTF-PACE-03` | PACE to Gmail API |
| `INTF-PACE-04` | PACE to Allsop Portal |
| `INTF-PACE-05` | PACE to Bayut |
| `INTF-PACE-06` | PACE to Property Finder |
| `INTF-PACE-07` | PACE to WhatsApp |
| `INTF-SF-01` | PACE to Salesforce Adapter |
